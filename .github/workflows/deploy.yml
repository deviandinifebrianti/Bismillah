name: Deploy Django App (PEMKOTMALANG-SIPRETI) to Debian 11

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Debian 11 Server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/g2141720189/sipreti/lancar/pemkot

            echo "ğŸ–¥ï¸  Server Info:"
            echo "OS: $(lsb_release -d 2>/dev/null || cat /etc/os-release | grep PRETTY_NAME)"
            echo "Python: $(python3 --version)"
            echo "Current path: $(pwd)"

            echo "ğŸ“¦ Creating backup..."
            mkdir -p ~/backups
            cp -r . ~/backups/backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || echo "Backup skipped"

            echo "â¬‡ï¸  Pulling latest changes..."
            git pull origin main

            echo "ğŸ”Œ Setting up virtual environment..."
            if [ ! -d ".venv" ]; then
                echo "Creating new virtual environment..."
                python3 -m venv .venv
            fi
            
            source .venv/bin/activate
            echo "Virtual environment activated"

            echo "ğŸ Python version in venv:"
            python --version

            echo "ğŸ“¦ Installing/upgrading packages..."
            python -m pip install --upgrade pip setuptools wheel
            
            if [ -f "requirements.txt" ]; then
                echo "Installing from requirements.txt..."
                pip install -r requirements.txt
            else
                echo "No requirements.txt found, installing basic Django..."
                pip install django pymysql
            fi

            echo "ğŸ§ª Running basic Django check..."
            python manage.py check --deploy 2>/dev/null || python manage.py check || echo "Django check completed with warnings"

            echo "ğŸ—„ï¸  Running migrations..."
            python manage.py migrate --noinput

            echo "ğŸ“ Collecting static files..."
            python manage.py collectstatic --noinput --clear

            echo "ğŸ”„ Restarting services..."
            # Restart Apache/Nginx (adjust based on your setup)
            sudo systemctl restart apache2 2>/dev/null || echo "Apache restart skipped"
            sudo systemctl restart nginx 2>/dev/null || echo "Nginx restart skipped"

            echo "âœ… Deployment completed successfully!"
            echo "ğŸ¯ Server: $(hostname)"
            echo "ğŸ“… Time: $(date)"

  notify:
    needs: deploy
    runs-on: ubuntu-22.04
    if: always()

    steps:
      - name: Notify Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… DEPLOYMENT SUCCESSFUL!"
            echo "ğŸŒ Django app deployed to server 34.142.128.41"
            echo "ğŸ“‚ Path: /home/g2141720189/sipreti/lancar/pemkot"
          else
            echo "âŒ DEPLOYMENT FAILED!"
            echo "Please check the logs above for errors"
          fi